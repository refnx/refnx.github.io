<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>refnx.util.general &mdash; refnx 0.0.3 documentation</title>
    
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '0.0.3',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="refnx 0.0.3 documentation" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" />
   
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9">

  </head>
  <body role="document">  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for refnx.util.general</h1><div class="highlight"><pre>
<span class="c">#!/usr/bin/python</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Functions for various calculations related to reflectometry</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">division</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span><span class="p">,</span> <span class="n">integrate</span><span class="p">,</span> <span class="n">constants</span><span class="p">,</span> <span class="n">optimize</span>

<span class="c">#h / m = 3956</span>
<span class="n">K</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">h</span> <span class="o">/</span> <span class="n">constants</span><span class="o">.</span><span class="n">m_n</span> <span class="o">*</span> <span class="mf">1.e10</span>


<div class="viewcode-block" id="div"><a class="viewcode-back" href="../../../refnx.util.html#refnx.util.general.div">[docs]</a><span class="k">def</span> <span class="nf">div</span><span class="p">(</span><span class="n">d1</span><span class="p">,</span> <span class="n">d2</span><span class="p">,</span> <span class="n">L12</span> <span class="o">=</span> <span class="mi">2859</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the angular resolution for a set of collimation conditions</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    d1: float</span>
<span class="sd">        slit 1 opening</span>
<span class="sd">    d2: float</span>
<span class="sd">        slit 2 opening</span>
<span class="sd">    L12: float</span>
<span class="sd">        distance between slits</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        (dtheta, alpha, beta)</span>

<span class="sd">    dtheta is the FWHM of the Gaussian approximation to the trapezoidal</span>
<span class="sd">    resolution function</span>
<span class="sd">    alpha is the angular divergence of the penumbra</span>
<span class="sd">    beta is the angular divergence of the umbra</span>

<span class="sd">    When calculating dtheta / theta values for resolution, then dtheta is the</span>
<span class="sd">    value you need to use.</span>
<span class="sd">    See equations 11-14 in:</span>

<span class="sd">    [1] de Haan, V.-O.; de Blois, J.; van der Ende, P.; Fredrikze, H.; van der</span>
<span class="sd">    Graaf, A.; Schipper, M.; van Well, A. A. &amp; J., v. d. Z. ROG, the neutron</span>
<span class="sd">    reflectometer at IRI Delft Nuclear Instruments and Methods in Physics</span>
<span class="sd">    Research A, 1995, 362, 434-453</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">divergence</span> <span class="o">=</span> <span class="mf">0.68</span> <span class="o">*</span> <span class="mf">0.68</span> <span class="o">*</span> <span class="p">(</span><span class="n">d1</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">d2</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">L12</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="p">(</span><span class="n">d1</span> <span class="o">+</span> <span class="n">d2</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.</span> <span class="o">/</span> <span class="n">L12</span>
    <span class="n">beta</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">d1</span> <span class="o">-</span> <span class="n">d2</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.</span> <span class="o">/</span> <span class="n">L12</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">divergence</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">alpha</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">beta</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="q"><a class="viewcode-back" href="../../../refnx.util.html#refnx.util.general.q">[docs]</a><span class="k">def</span> <span class="nf">q</span><span class="p">(</span><span class="n">angle</span><span class="p">,</span> <span class="n">wavelength</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate Q given angle of incidence and wavelength</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    angle: float</span>
<span class="sd">        angle of incidence (degrees)</span>
<span class="sd">    wavelength: float</span>
<span class="sd">        wavelength of radiation (Angstrom)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Q: float</span>
<span class="sd">        Momentum transfer (A**-1)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">angle</span><span class="p">))</span> <span class="o">/</span> <span class="n">wavelength</span>

</div>
<span class="nd">@np.vectorize</span>
<span class="k">def</span> <span class="nf">q2</span><span class="p">(</span><span class="n">omega</span><span class="p">,</span> <span class="n">twotheta</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="n">wavelength</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    convert angles and wavelength (lambda) to Q vector.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    omega: float</span>
<span class="sd">        angle of incidence of beam (in xy plane)</span>
<span class="sd">    twotheta: float</span>
<span class="sd">        angle between direct beam and projected reflected beam onto yz plane</span>
<span class="sd">    phi: float</span>
<span class="sd">        angle between reflected beam and yz plane.</span>
<span class="sd">    wavelength: float</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Qx, Qy, Qz : float, float, float</span>
<span class="sd">        Momentum transfer in A**-1.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    coordinate system:</span>
<span class="sd">    y - along beam direction (in small angle approximation)</span>
<span class="sd">    x - transverse to beam direction, in plane of sample</span>
<span class="sd">    z - normal to sample plane.</span>
<span class="sd">    the xy plane is equivalent to the sample plane.</span>

<span class="sd">    TODO: check</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">omega</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">omega</span><span class="p">)</span>
    <span class="n">twotheta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">twotheta</span><span class="p">)</span>
    <span class="n">phi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span>

    <span class="n">qx</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="n">wavelength</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">twotheta</span> <span class="o">-</span> <span class="n">omega</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span>
    <span class="n">qy</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="n">wavelength</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">twotheta</span> <span class="o">-</span> <span class="n">omega</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span>
          <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">omega</span><span class="p">)))</span>
    <span class="n">qz</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="n">wavelength</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">twotheta</span> <span class="o">-</span> <span class="n">omega</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">omega</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">qz</span>


<div class="viewcode-block" id="wavelength"><a class="viewcode-back" href="../../../refnx.util.html#refnx.util.general.wavelength">[docs]</a><span class="k">def</span> <span class="nf">wavelength</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">angle</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    calculate wavelength given Q vector and angle</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    q : float</span>
<span class="sd">        Wavevector (A**-1)</span>
<span class="sd">    angle : float</span>
<span class="sd">        angle of incidence (degrees)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    wavelength : float</span>
<span class="sd">        Wavelength of radiation (A)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="mf">4.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">angle</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">180.</span><span class="p">)</span><span class="o">/</span><span class="n">q</span>

</div>
<div class="viewcode-block" id="angle"><a class="viewcode-back" href="../../../refnx.util.html#refnx.util.general.angle">[docs]</a><span class="k">def</span> <span class="nf">angle</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">wavelength</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    calculate angle given Q and wavelength</span>
<span class="sd">    q - wavevector (A^-1)</span>
<span class="sd">    wavelength -  wavelength of radiation (Angstrom)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span>  <span class="n">np</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="n">q</span> <span class="o">/</span> <span class="mf">4.</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">wavelength</span><span class="p">)</span> <span class="o">*</span> <span class="mi">180</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>

</div>
<div class="viewcode-block" id="qcrit"><a class="viewcode-back" href="../../../refnx.util.html#refnx.util.general.qcrit">[docs]</a><span class="k">def</span> <span class="nf">qcrit</span><span class="p">(</span><span class="n">SLD1</span><span class="p">,</span> <span class="n">SLD2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    calculate critical Q vector given SLD of super and subphases</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    SLD1: float</span>
<span class="sd">        SLD of superphase (10^-6 A^-2)</span>
<span class="sd">    SLD2: float</span>
<span class="sd">        SLD of subphase (10^-6 A^-2)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    qc: float</span>
<span class="sd">        Critical Q vector for a reflectivity system.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">16.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">SLD2</span> <span class="o">-</span> <span class="n">SLD1</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.e-6</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="tauC"><a class="viewcode-back" href="../../../refnx.util.html#refnx.util.general.tauC">[docs]</a><span class="k">def</span> <span class="nf">tauC</span><span class="p">(</span><span class="n">wavelength</span><span class="p">,</span> <span class="n">xsi</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">z0</span><span class="o">=</span><span class="mf">0.358</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="mi">24</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the burst time of a double chopper pair</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    wavelength: float</span>
<span class="sd">        wavelength in Angstroms</span>
<span class="sd">    z0: float</span>
<span class="sd">        distance between chopper pair (m)</span>
<span class="sd">    freq: float</span>
<span class="sd">        rotation frequency of choppers (Hz)</span>
<span class="sd">    xsi: float</span>
<span class="sd">        phase opening of chopper pair (degrees)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tauC: float</span>
<span class="sd">        The burst time of a double chopper pair (s)</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    [1] A. A. van Well and H. Fredrikze, On the resolution and intensity of a</span>
<span class="sd">    time-of-flight neutron reflectometer, Physica B 357 (2005) 204-207</span>
<span class="sd">    [2] A. Nelson and C. Dewhurst, Towards a detailed resolution smearing</span>
<span class="sd">    kernel for time-of-flight neutron reflectometers, J. Appl. Cryst. (2013)</span>
<span class="sd">    46, 1338-1343</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tauC</span> <span class="o">=</span> <span class="n">z0</span> <span class="o">/</span> <span class="n">wavelength_velocity</span><span class="p">(</span><span class="n">wavelength</span><span class="p">)</span>
    <span class="n">tauC</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">xsi</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">freq</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">tauC</span>

</div>
<div class="viewcode-block" id="wavelength_velocity"><a class="viewcode-back" href="../../../refnx.util.html#refnx.util.general.wavelength_velocity">[docs]</a><span class="k">def</span> <span class="nf">wavelength_velocity</span><span class="p">(</span><span class="n">wavelength</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Converts wavelength to neutron velocity</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    wavelength: float</span>
<span class="sd">        wavelength of neutron in Angstrom.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    velocity: float</span>
<span class="sd">        velocity of neutron in ms**-1</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">K</span> <span class="o">/</span> <span class="n">wavelength</span>

</div>
<div class="viewcode-block" id="velocity_wavelength"><a class="viewcode-back" href="../../../refnx.util.html#refnx.util.general.velocity_wavelength">[docs]</a><span class="k">def</span> <span class="nf">velocity_wavelength</span><span class="p">(</span><span class="n">velocity</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Converts neutron velocity to wavelength</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    velocity: float</span>
<span class="sd">        velocity of neutron in m/s</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    wavelength: float</span>
<span class="sd">        wavelength of neutron in A</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">K</span> <span class="o">/</span> <span class="n">velocity</span>

</div>
<div class="viewcode-block" id="wavelength_energy"><a class="viewcode-back" href="../../../refnx.util.html#refnx.util.general.wavelength_energy">[docs]</a><span class="k">def</span> <span class="nf">wavelength_energy</span><span class="p">(</span><span class="n">wavelength</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Converts wavelength to energy in meV</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    wavelength : float</span>
<span class="sd">        Wavelength in Angstrom.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    energy : float</span>
<span class="sd">        Energy in meV.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">c</span> <span class="o">=</span> <span class="mf">0.5e23</span> <span class="o">/</span> <span class="n">constants</span><span class="o">.</span><span class="n">eV</span> <span class="o">*</span> <span class="n">constants</span><span class="o">.</span><span class="n">h</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">constants</span><span class="o">.</span><span class="n">m_n</span>
    <span class="k">return</span> <span class="n">c</span> <span class="o">/</span> <span class="n">wavelength</span> <span class="o">**</span> <span class="mi">2</span>

</div>
<div class="viewcode-block" id="energy_wavelength"><a class="viewcode-back" href="../../../refnx.util.html#refnx.util.general.energy_wavelength">[docs]</a><span class="k">def</span> <span class="nf">energy_wavelength</span><span class="p">(</span><span class="n">energy</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Converts wavelength to energy in meV</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    energy : float</span>
<span class="sd">        Energy in meV.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    wavelength : float</span>
<span class="sd">        Wavelength in Angstrom.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">c</span> <span class="o">=</span> <span class="mf">0.5e23</span> <span class="o">/</span> <span class="n">constants</span><span class="o">.</span><span class="n">eV</span> <span class="o">*</span> <span class="n">constants</span><span class="o">.</span><span class="n">h</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">constants</span><span class="o">.</span><span class="n">m_n</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">c</span> <span class="o">/</span> <span class="n">energy</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="double_chopper_frequency"><a class="viewcode-back" href="../../../refnx.util.html#refnx.util.general.double_chopper_frequency">[docs]</a><span class="k">def</span> <span class="nf">double_chopper_frequency</span><span class="p">(</span><span class="n">min_wavelength</span><span class="p">,</span> <span class="n">max_wavelength</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the maximum frequency available for a given wavelength band</span>
<span class="sd">    without getting frame overlap in a chopper spectrometer.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    min_wavelength: float</span>
<span class="sd">        minimum wavelength to be used</span>
<span class="sd">    max_wavelength: float</span>
<span class="sd">        maximum wavelength to be used</span>
<span class="sd">    L: float</span>
<span class="sd">        Flight length of instrument (m)</span>
<span class="sd">    N: float, optional</span>
<span class="sd">        number of windows in chopper pair</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    max_freq: float</span>
<span class="sd">        The maximum frequency a double chopper system can use to avoid frame</span>
<span class="sd">        overlap.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">K</span> <span class="o">/</span> <span class="p">((</span><span class="n">max_wavelength</span> <span class="o">-</span> <span class="n">min_wavelength</span><span class="p">)</span> <span class="o">*</span> <span class="n">L</span> <span class="o">*</span> <span class="n">N</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="resolution_double_chopper"><a class="viewcode-back" href="../../../refnx.util.html#refnx.util.general.resolution_double_chopper">[docs]</a><span class="k">def</span> <span class="nf">resolution_double_chopper</span><span class="p">(</span><span class="n">wavelength</span><span class="p">,</span> <span class="n">z0</span><span class="o">=</span><span class="mf">0.358</span><span class="p">,</span> <span class="n">R</span><span class="o">=</span><span class="mf">0.35</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="mi">24</span><span class="p">,</span>
                              <span class="n">H</span><span class="o">=</span><span class="mf">0.005</span><span class="p">,</span> <span class="n">xsi</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">L</span><span class="o">=</span><span class="mf">7.5</span><span class="p">,</span> <span class="n">tau_da</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the fractional resolution of a double chopper pair, dl/l.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    wavelength: float</span>
<span class="sd">        wavelength in Angstroms</span>
<span class="sd">    z0: float</span>
<span class="sd">        distance between chopper pair (m)</span>
<span class="sd">    R: float</span>
<span class="sd">        radius of chopper discs (m)</span>
<span class="sd">    freq: float</span>
<span class="sd">        rotation frequency of choppers (Hz)</span>
<span class="sd">    N: float</span>
<span class="sd">        number of windows in chopper pair</span>
<span class="sd">    H: float</span>
<span class="sd">        height of beam (m)</span>
<span class="sd">    xsi: float</span>
<span class="sd">        phase opening of chopper pair (degrees)</span>
<span class="sd">    L: float</span>
<span class="sd">        Flight length of instrument (m)</span>
<span class="sd">    tau_da : float</span>
<span class="sd">        Width of timebin (s)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    res: float</span>
<span class="sd">        Fractional wavelength resolution of a double chopper system.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">TOF</span> <span class="o">=</span> <span class="n">L</span> <span class="o">/</span> <span class="n">wavelength_velocity</span><span class="p">(</span><span class="n">wavelength</span><span class="p">)</span>
    <span class="n">tc</span> <span class="o">=</span> <span class="n">tauC</span><span class="p">(</span><span class="n">wavelength</span><span class="p">,</span> <span class="n">xsi</span><span class="o">=</span><span class="n">xsi</span><span class="p">,</span> <span class="n">z0</span><span class="o">=</span><span class="n">z0</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="n">freq</span><span class="p">)</span>
    <span class="n">tau_h</span> <span class="o">=</span> <span class="n">H</span> <span class="o">/</span> <span class="n">R</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">freq</span><span class="p">)</span>
    <span class="k">return</span> <span class="mf">0.68</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">tc</span> <span class="o">/</span> <span class="n">TOF</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">tau_h</span> <span class="o">/</span> <span class="n">TOF</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">tau_da</span> <span class="o">/</span> <span class="n">TOF</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="resolution_single_chopper"><a class="viewcode-back" href="../../../refnx.util.html#refnx.util.general.resolution_single_chopper">[docs]</a><span class="k">def</span> <span class="nf">resolution_single_chopper</span><span class="p">(</span><span class="n">wavelength</span><span class="p">,</span> <span class="n">R</span><span class="o">=</span><span class="mf">0.35</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="mi">24</span><span class="p">,</span> <span class="n">H</span><span class="o">=</span><span class="mf">0.005</span><span class="p">,</span> <span class="n">phi</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
                              <span class="n">L</span><span class="o">=</span><span class="mf">7.5</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the fractional resolution of a single chopper, dl/l.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    wavelength: float</span>
<span class="sd">        wavelength in Angstroms</span>
<span class="sd">    R: float</span>
<span class="sd">        radius of chopper discs (m)</span>
<span class="sd">    freq: float</span>
<span class="sd">        rotation frequency of choppers (Hz)</span>
<span class="sd">    N: float</span>
<span class="sd">        number of windows in chopper</span>
<span class="sd">    H: float</span>
<span class="sd">        height of beam (m)</span>
<span class="sd">    phi: float</span>
<span class="sd">        angular opening of chopper window (degrees)</span>
<span class="sd">    L: float</span>
<span class="sd">        Flight length of instrument (m)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    transmission: float</span>
<span class="sd">        Transmission of a single chopper system.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">TOF</span> <span class="o">=</span> <span class="n">L</span> <span class="o">/</span> <span class="n">wavelength_velocity</span><span class="p">(</span><span class="n">wavelength</span><span class="p">)</span>
    <span class="n">tauH</span> <span class="o">=</span> <span class="n">H</span> <span class="o">/</span> <span class="n">R</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">freq</span><span class="p">)</span>
    <span class="n">tauC</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">freq</span><span class="p">)</span>
    <span class="k">return</span> <span class="mf">0.68</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">tauC</span> <span class="o">/</span> <span class="n">TOF</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">tauH</span> <span class="o">/</span> <span class="n">TOF</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="transmission_double_chopper"><a class="viewcode-back" href="../../../refnx.util.html#refnx.util.general.transmission_double_chopper">[docs]</a><span class="k">def</span> <span class="nf">transmission_double_chopper</span><span class="p">(</span><span class="n">wavelength</span><span class="p">,</span> <span class="n">z0</span><span class="o">=</span><span class="mf">0.358</span><span class="p">,</span> <span class="n">R</span><span class="o">=</span><span class="mf">0.35</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="mi">24</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                <span class="n">H</span><span class="o">=</span><span class="mf">0.005</span><span class="p">,</span> <span class="n">xsi</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the transmission of a double chopper pair</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    wavelength: float</span>
<span class="sd">        wavelength in Angstroms</span>
<span class="sd">    z0: float</span>
<span class="sd">        distance between chopper pair (m)</span>
<span class="sd">    R: float</span>
<span class="sd">        radius of chopper discs (m)</span>
<span class="sd">    freq: float</span>
<span class="sd">        rotation frequency of choppers (Hz)</span>
<span class="sd">    N: float</span>
<span class="sd">        number of windows in chopper pair</span>
<span class="sd">    H: float</span>
<span class="sd">        height of beam (m)</span>
<span class="sd">    xsi: float</span>
<span class="sd">        phase opening of chopper pair (degrees)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    transmission: float</span>
<span class="sd">        The transmission of a double chopper system.</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    [1] A. A. van Well and H. Fredrikze, On the resolution and intensity of a</span>
<span class="sd">    time-of-flight neutron reflectometer, Physica B 357 (2005) 204-207</span>
<span class="sd">    [2] A. Nelson and C. Dewhurst, Towards a detailed resolution smearing</span>
<span class="sd">    kernel for time-of-flight neutron reflectometers, J. Appl. Cryst. (2013)</span>
<span class="sd">    46, 1338-1343</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">transmission</span> <span class="o">=</span> <span class="n">tauC</span><span class="p">(</span><span class="n">wavelength</span><span class="p">,</span> <span class="n">xsi</span><span class="o">=</span><span class="n">xsi</span><span class="p">,</span> <span class="n">z0</span><span class="o">=</span><span class="n">z0</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="n">freq</span><span class="p">)</span> <span class="o">*</span> <span class="n">freq</span>
    <span class="n">transmission</span> <span class="o">+=</span> <span class="n">H</span> <span class="o">*</span> <span class="n">constants</span><span class="o">.</span><span class="n">h</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">R</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">transmission</span> <span class="o">*</span> <span class="n">N</span>

</div>
<div class="viewcode-block" id="transmission_single_chopper"><a class="viewcode-back" href="../../../refnx.util.html#refnx.util.general.transmission_single_chopper">[docs]</a><span class="k">def</span> <span class="nf">transmission_single_chopper</span><span class="p">(</span><span class="n">R</span><span class="o">=</span><span class="mf">0.35</span><span class="p">,</span> <span class="n">phi</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">H</span><span class="o">=</span><span class="mf">0.005</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the transmission of a single chopper</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    R: float</span>
<span class="sd">        radius of chopper discs (m)</span>
<span class="sd">    phi: float</span>
<span class="sd">        angular opening of chopper disc (degrees)</span>
<span class="sd">    N: float</span>
<span class="sd">        number of windows in chopper pair</span>
<span class="sd">    H: float</span>
<span class="sd">        height of beam (m)</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    [1] A. A. van Well and H. Fredrikze, On the resolution and intensity of a</span>
<span class="sd">    time-of-flight neutron reflectometer, Physica B 357 (2005) 204-207</span>
<span class="sd">    [2] A. Nelson and C. Dewhurst, Towards a detailed resolution smearing</span>
<span class="sd">    kernel for time-of-flight neutron reflectometers, J. Appl. Cryst. (2013)</span>
<span class="sd">    46, 1338-1343</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">N</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span> <span class="o">*</span> <span class="n">R</span> <span class="o">+</span> <span class="n">H</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">R</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="xray_wavelength"><a class="viewcode-back" href="../../../refnx.util.html#refnx.util.general.xray_wavelength">[docs]</a><span class="k">def</span> <span class="nf">xray_wavelength</span><span class="p">(</span><span class="n">energy</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    convert energy (keV) to wavelength (angstrom)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="mf">12.398</span><span class="o">/</span> <span class="n">energy</span>

</div>
<div class="viewcode-block" id="xray_energy"><a class="viewcode-back" href="../../../refnx.util.html#refnx.util.general.xray_energy">[docs]</a><span class="k">def</span> <span class="nf">xray_energy</span><span class="p">(</span><span class="n">wavelength</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    convert energy (keV) to wavelength (angstrom)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="mf">12.398</span><span class="o">/</span> <span class="n">wavelength</span>

</div>
<div class="viewcode-block" id="penetration_depth"><a class="viewcode-back" href="../../../refnx.util.html#refnx.util.general.penetration_depth">[docs]</a><span class="k">def</span> <span class="nf">penetration_depth</span><span class="p">(</span><span class="n">qq</span><span class="p">,</span> <span class="n">rho</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the penetration depth of a neutron/xray beam</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    qq: float</span>
<span class="sd">        Q values to calculate the penetration depth at</span>
<span class="sd">    rho: float or complex</span>
<span class="sd">        Complex SLD of material</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    penetration_depth: float</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">kk</span> <span class="o">=</span> <span class="mf">0.25</span> <span class="o">*</span> <span class="n">qq</span> <span class="o">**</span> <span class="mf">2.</span>
    <span class="n">kk</span> <span class="o">-=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">rho</span>
    <span class="n">temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">kk</span> <span class="o">+</span> <span class="mi">0j</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">temp</span><span class="o">.</span><span class="n">imag</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="beamfrac"><a class="viewcode-back" href="../../../refnx.util.html#refnx.util.general.beamfrac">[docs]</a><span class="k">def</span> <span class="nf">beamfrac</span><span class="p">(</span><span class="n">FWHM</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">angle</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the beam fraction intercepted by a sample.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    FWHM: float</span>
<span class="sd">        The FWHM of the beam height</span>
<span class="sd">    length: float</span>
<span class="sd">        Length of the sample in mm</span>
<span class="sd">    angle: float</span>
<span class="sd">        Angle that the sample makes w.r.t the beam (degrees)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    beamfrac: float</span>
<span class="sd">        The fraction of the beam that intercepts the sample</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">height_of_sample</span> <span class="o">=</span> <span class="n">length</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">angle</span><span class="p">))</span>
    <span class="n">beam_sd</span> <span class="o">=</span> <span class="n">FWHM</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">probability</span> <span class="o">=</span> <span class="mf">2.</span> <span class="o">*</span> <span class="p">(</span><span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">height_of_sample</span> <span class="o">/</span> <span class="mf">2.</span> <span class="o">/</span> <span class="n">beam_sd</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">probability</span>

</div>
<div class="viewcode-block" id="beamfrackernel"><a class="viewcode-back" href="../../../refnx.util.html#refnx.util.general.beamfrackernel">[docs]</a><span class="k">def</span> <span class="nf">beamfrackernel</span><span class="p">(</span><span class="n">kernelx</span><span class="p">,</span> <span class="n">kernely</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">angle</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The beam fraction intercepted by a sample, used for calculating footprints.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    kernelx: array-like</span>
<span class="sd">        x axis for the probability kernel</span>
<span class="sd">    kernely: array-like</span>
<span class="sd">        probability kernel describing the intensity distribution of the beam</span>
<span class="sd">    length: float</span>
<span class="sd">        length of the sample</span>
<span class="sd">    angle: float</span>
<span class="sd">        angle of incidence (degrees)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    fraction: float</span>
<span class="sd">        The fraction of the beam intercepted by a sample.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">height_of_sample</span> <span class="o">=</span> <span class="n">length</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">angle</span><span class="p">))</span>
    <span class="n">total</span> <span class="o">=</span> <span class="n">integrate</span><span class="o">.</span><span class="n">simps</span><span class="p">(</span><span class="n">kernely</span><span class="p">,</span> <span class="n">kernelx</span><span class="p">)</span>
    <span class="n">lowlimit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">-</span><span class="n">height_of_sample</span> <span class="o">/</span> <span class="mf">2.</span> <span class="o">&gt;=</span> <span class="n">kernelx</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">hilimit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">height_of_sample</span> <span class="o">/</span> <span class="mf">2.</span> <span class="o">&lt;=</span> <span class="n">kernelx</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">area</span> <span class="o">=</span> <span class="n">integrate</span><span class="o">.</span><span class="n">simps</span><span class="p">(</span><span class="n">kernely</span><span class="p">[</span><span class="n">lowlimit</span><span class="p">:</span> <span class="n">hilimit</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span>
                           <span class="n">kernelx</span><span class="p">[</span><span class="n">lowlimit</span><span class="p">:</span> <span class="n">hilimit</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">area</span> <span class="o">/</span> <span class="n">total</span>

</div>
<div class="viewcode-block" id="height_of_beam_after_dx"><a class="viewcode-back" href="../../../refnx.util.html#refnx.util.general.height_of_beam_after_dx">[docs]</a><span class="k">def</span> <span class="nf">height_of_beam_after_dx</span><span class="p">(</span><span class="n">d1</span><span class="p">,</span> <span class="n">d2</span><span class="p">,</span> <span class="n">L12</span><span class="p">,</span> <span class="n">distance</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the widths of beam a given distance away from a collimation slit.</span>

<span class="sd">    if distance &gt;= 0, then it&#39;s taken to be the distance after d2.</span>
<span class="sd">    if distance &lt; 0, then it&#39;s taken to be the distance before d1.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    d1: float</span>
<span class="sd">        opening of first collimation slit</span>
<span class="sd">    d2: float</span>
<span class="sd">        opening of second collimation slit</span>
<span class="sd">    L12: float</span>
<span class="sd">        distance between first and second collimation slits</span>
<span class="sd">    distance: float</span>
<span class="sd">        distance from first or last slit to a given position</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Units - equivalent distances (inches, mm, light years)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    (umbra, penumbra): float, float</span>
<span class="sd">        height of umbra and penumbra</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">alpha</span> <span class="o">=</span> <span class="p">(</span><span class="n">d1</span> <span class="o">+</span> <span class="n">d2</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.</span> <span class="o">/</span> <span class="n">L12</span>
    <span class="n">beta</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">d1</span> <span class="o">-</span> <span class="n">d2</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.</span> <span class="o">/</span> <span class="n">L12</span>
    <span class="k">if</span> <span class="n">distance</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">beta</span> <span class="o">*</span> <span class="n">distance</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">d2</span><span class="p">,</span> <span class="p">(</span><span class="n">alpha</span> <span class="o">*</span> <span class="n">distance</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">d2</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">beta</span> <span class="o">*</span> <span class="nb">abs</span><span class="p">(</span><span class="n">distance</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">d1</span><span class="p">,</span> <span class="p">(</span><span class="n">alpha</span> <span class="o">*</span> <span class="nb">abs</span><span class="p">(</span><span class="n">distance</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">d1</span>

</div>
<div class="viewcode-block" id="actual_footprint"><a class="viewcode-back" href="../../../refnx.util.html#refnx.util.general.actual_footprint">[docs]</a><span class="k">def</span> <span class="nf">actual_footprint</span><span class="p">(</span><span class="n">d1</span><span class="p">,</span> <span class="n">d2</span><span class="p">,</span> <span class="n">L12</span><span class="p">,</span> <span class="n">L2S</span><span class="p">,</span> <span class="n">angle</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the actual footprint on a reflectivity sample.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    d1: float</span>
<span class="sd">        opening of first collimation slit</span>
<span class="sd">    d2: float</span>
<span class="sd">        opening of second collimation slit</span>
<span class="sd">    L12: float</span>
<span class="sd">        distance between first and second collimation slits</span>
<span class="sd">    L2S: float</span>
<span class="sd">        distance from second collimation slit to sample</span>
<span class="sd">    angle: float</span>
<span class="sd">        angle of incidence of sample (degrees)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    (umbra_footprint, penumbra_footprint): float, float</span>
<span class="sd">        Footprint of the umbra and penumbra</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">umbra</span><span class="p">,</span> <span class="n">penumbra</span> <span class="o">=</span> <span class="n">height_of_beam_after_dx</span><span class="p">(</span><span class="n">d1</span><span class="p">,</span> <span class="n">d2</span><span class="p">,</span> <span class="n">L12</span><span class="p">,</span> <span class="n">L2S</span><span class="p">)</span>
    <span class="k">return</span>  <span class="n">umbra</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">angle</span><span class="p">),</span> <span class="n">penumbra</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="slit_optimiser"><a class="viewcode-back" href="../../../refnx.util.html#refnx.util.general.slit_optimiser">[docs]</a><span class="k">def</span> <span class="nf">slit_optimiser</span><span class="p">(</span><span class="n">footprint</span><span class="p">,</span>
                  <span class="n">resolution</span><span class="p">,</span>
                  <span class="n">angle</span> <span class="o">=</span> <span class="mf">1.</span><span class="p">,</span>
                  <span class="n">L12</span> <span class="o">=</span> <span class="mf">2859.5</span><span class="p">,</span>
                  <span class="n">L2S</span> <span class="o">=</span> <span class="mi">180</span><span class="p">,</span>
                  <span class="n">LS3</span> <span class="o">=</span> <span class="mf">290.5</span><span class="p">,</span>
                  <span class="n">LSD</span> <span class="o">=</span> <span class="mi">2500</span><span class="p">,</span>
                  <span class="n">verbose</span> <span class="o">=</span> <span class="bp">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Optimise slit settings for a given angular resolution, and a given footprint.</span>

<span class="sd">    footprint: float</span>
<span class="sd">        maximum footprint onto sample (mm)</span>
<span class="sd">    resolution: float</span>
<span class="sd">        fractional dtheta/theta resolution (FWHM)</span>
<span class="sd">    angle: float, optional</span>
<span class="sd">        angle of incidence in degrees</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;_____________________________________________&#39;</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;FOOTPRINT calculator - Andrew Nelson 2013&#39;</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;INPUT&#39;</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;footprint:&#39;</span><span class="p">,</span> <span class="n">footprint</span><span class="p">,</span> <span class="s">&#39;mm&#39;</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;fractional angular resolution (FWHM):&#39;</span><span class="p">,</span> <span class="n">resolution</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;theta:&#39;</span><span class="p">,</span> <span class="n">angle</span><span class="p">,</span> <span class="s">&#39;degrees&#39;</span><span class="p">)</span>

    <span class="n">d1star</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">d2star</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">d2star</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
    <span class="n">L1star</span> <span class="o">=</span> <span class="mf">0.68</span> <span class="o">*</span> <span class="n">footprint</span><span class="o">/</span><span class="n">L12</span><span class="o">/</span><span class="n">resolution</span>

    <span class="n">gseekfun</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">d2star</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">((</span><span class="n">d2star</span> <span class="o">+</span> <span class="n">L2S</span> <span class="o">/</span> <span class="n">L12</span> <span class="o">*</span> <span class="p">(</span><span class="n">d2star</span> <span class="o">+</span> <span class="n">d1star</span><span class="p">(</span><span class="n">d2star</span><span class="p">)))</span> <span class="o">-</span> <span class="n">L1star</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

    <span class="n">res</span> <span class="o">=</span> <span class="n">optimize</span><span class="o">.</span><span class="n">minimize_scalar</span><span class="p">(</span><span class="n">gseekfun</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s">&#39;bounded&#39;</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">res</span><span class="p">[</span><span class="s">&#39;success&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;ERROR: Couldnt find optimal solution, sorry&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">None</span>

    <span class="n">optimal_d2star</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s">&#39;x&#39;</span><span class="p">]</span>
    <span class="n">optimal_d1star</span> <span class="o">=</span> <span class="n">d1star</span><span class="p">(</span><span class="n">optimal_d2star</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">optimal_d2star</span> <span class="o">&gt;</span> <span class="n">optimal_d1star</span><span class="p">:</span>
        <span class="c"># you found a minimum, but this may not be the optimum size of the slits.</span>
        <span class="n">multfactor</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">optimal_d2star</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">optimal_d1star</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">multfactor</span> <span class="o">=</span> <span class="n">optimal_d2star</span> <span class="o">/</span> <span class="n">optimal_d1star</span>

    <span class="n">d1</span> <span class="o">=</span> <span class="n">optimal_d1star</span> <span class="o">*</span> <span class="n">resolution</span> <span class="o">/</span> <span class="mf">0.68</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span> <span class="o">*</span> <span class="n">L12</span>
    <span class="n">d2</span> <span class="o">=</span> <span class="n">d1</span> <span class="o">*</span> <span class="n">multfactor</span>

    <span class="n">tmp</span><span class="p">,</span> <span class="n">height_at_S4</span> <span class="o">=</span> <span class="n">height_of_beam_after_dx</span><span class="p">(</span><span class="n">d1</span><span class="p">,</span> <span class="n">d2</span><span class="p">,</span> <span class="n">L12</span><span class="p">,</span> <span class="n">L2S</span> <span class="o">+</span> <span class="n">LS3</span><span class="p">)</span>
    <span class="n">tmp</span><span class="p">,</span> <span class="n">height_at_detector</span> <span class="o">=</span> <span class="n">height_of_beam_after_dx</span><span class="p">(</span><span class="n">d1</span><span class="p">,</span> <span class="n">d2</span><span class="p">,</span> <span class="n">L12</span><span class="p">,</span> <span class="n">L2S</span> <span class="o">+</span> <span class="n">LSD</span><span class="p">)</span>
    <span class="n">tmp</span><span class="p">,</span> <span class="n">_actual_footprint</span> <span class="o">=</span> <span class="n">actual_footprint</span><span class="p">(</span><span class="n">d1</span><span class="p">,</span> <span class="n">d2</span><span class="p">,</span> <span class="n">L12</span><span class="p">,</span> <span class="n">L2S</span><span class="p">,</span> <span class="n">angle</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;OUTPUT&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">multfactor</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;Your desired resolution results in a smaller footprint than the sample supports.&#39;</span><span class="p">)</span>
            <span class="n">suggested_resolution</span> <span class="o">=</span>  <span class="n">resolution</span> <span class="o">*</span> <span class="n">footprint</span> <span class="o">/</span> <span class="n">_actual_footprint</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;You can increase flux using a resolution of&#39;</span><span class="p">,</span> <span class="n">suggested_resolution</span><span class="p">,</span> <span class="s">&#39;and still keep the same footprint.&#39;</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;d1&#39;</span><span class="p">,</span> <span class="n">d1</span><span class="p">,</span> <span class="s">&#39;mm&#39;</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;d2&#39;</span><span class="p">,</span> <span class="n">d2</span><span class="p">,</span> <span class="s">&#39;mm&#39;</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;footprint:&#39;</span><span class="p">,</span> <span class="n">_actual_footprint</span><span class="p">,</span> <span class="s">&#39;mm&#39;</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;height at S4:&#39;</span><span class="p">,</span> <span class="n">height_at_S4</span><span class="p">,</span> <span class="s">&#39;mm&#39;</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;height at detector:&#39;</span><span class="p">,</span> <span class="n">height_at_detector</span><span class="p">,</span> <span class="s">&#39;mm&#39;</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;[d2star&#39;</span><span class="p">,</span> <span class="n">optimal_d2star</span><span class="p">,</span> <span class="s">&#39;]&#39;</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;_____________________________________________&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">d1</span><span class="p">,</span> <span class="n">d2</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2015, Andrew Nelson.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.3.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.6</a>
      
    </div>

    

    
  </body>
</html>